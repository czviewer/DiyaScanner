<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AbsentEase QR Scanner</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

  <!-- QR scanner -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <!-- JWT decode (only for decoding, no verification) -->
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #333;
    }

    #qr-reader {
      width: 320px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 20px;
    }

    #message {
      min-height: 60px;
      width: 320px;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
      box-sizing: border-box;
      background: #fff;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
    }

    .success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
    }

    .error {
      color: #721c24;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
    }

    .info {
      color: #0c5460;
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
    }

    button {
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background: #0056b3;
    }
  </style>
</head>

<body>
  <h2>AbsentEase QR Attendance Scanner</h2>
  <div id="qr-reader"></div>
  <div id="message" class="info">Please login to scan attendance QR codes.</div>
  <button id="logout-btn" style="display:none;">Logout</button>

  <script>
    // Firebase config - replace with your own config from Firebase Console
    const firebaseConfig = {
      apiKey: "AIzaSyCwbK4jLFqPcb6mecLre-Vg5Wt6v1wldQM",
      authDomain: "diya-motors-tracker.firebaseapp.com",
      databaseURL: "https://diya-motors-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "diya-motors-tracker",
      storageBucket: "diya-motors-tracker.appspot.com",
      messagingSenderId: "863309961024",
      appId: "1:863309961024:web:fec49e4d58807d9f758414"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const functions = firebase.functions();

    // HTML elements
    const qrReader = new Html5Qrcode("qr-reader");
    const messageDiv = document.getElementById("message");
    const logoutBtn = document.getElementById("logout-btn");

    let scanning = false;

    // Show messages with style
    function showMessage(text, type = "info") {
      messageDiv.textContent = text;
      messageDiv.className = type;
    }

    // Start scanning
    async function startScanner() {
      if (scanning) return;
      showMessage("Starting camera... please allow camera access.", "info");

      try {
        const cameras = await Html5Qrcode.getCameras();
        if (!cameras || cameras.length === 0) {
          showMessage("No camera found on device.", "error");
          return;
        }

        // Prefer back camera if available
        const backCamera = cameras.find(cam => /back|rear|environment/gi.test(cam.label));
        const cameraId = backCamera ? backCamera.id : cameras[0].id;

        await qrReader.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          onScanSuccess,
          onScanFailure
        );
        scanning = true;
        showMessage("Camera started. Scan a valid QR code.", "info");
      } catch (e) {
        showMessage("Camera start failed: " + e.message, "error");
      }
    }

    // Stop scanning
    async function stopScanner() {
      if (!scanning) return;
      await qrReader.stop();
      scanning = false;
    }

    // Called on successful scan of QR code text
    async function onScanSuccess(decodedText, decodedResult) {
      await stopScanner(); // Pause scanning to process

      // Basic JWT format check: 3 parts separated by '.'
      if (!decodedText || decodedText.split('.').length !== 3) {
        showMessage("❌ Invalid QR code format. Expected JWT token.", "error");
        setTimeout(startScanner, 3000);
        return;
      }

      // Decode token to check expiry etc (client side only)
      let payload;
      try {
        payload = jwt_decode(decodedText);
      } catch {
        showMessage("❌ Failed to decode JWT token.", "error");
        setTimeout(startScanner, 3000);
        return;
      }

      // Check expiry if available
      if (payload.exp && (Date.now() / 1000) > payload.exp) {
        showMessage("❌ QR code expired.", "error");
        setTimeout(startScanner, 3000);
        return;
      }

      showMessage("✅ Valid QR scanned. Sending to server...", "info");

      try {
        const recordAttendance = functions.httpsCallable("recordAttendance");
        const result = await recordAttendance({ token: decodedText });

        if (result.data.success) {
          showMessage(`✅ Attendance recorded for Employee: ${payload.employeeId || "Unknown"}`, "success");
        } else {
          showMessage("❌ Failed: " + (result.data.message || "Unknown error"), "error");
        }
      } catch (error) {
        showMessage("❌ Server error: " + (error.message || error), "error");
        console.error(error);
      }

      setTimeout(startScanner, 3000);
    }

    // Called repeatedly when scanning fails (no QR in frame)
    function onScanFailure(error) {
      // Do nothing, to reduce noise
    }

    // Handle login state
    auth.onAuthStateChanged(user => {
      if (user) {
        showMessage(`Logged in as ${user.email}`, "info");
        logoutBtn.style.display = "inline-block";
        startScanner();
      } else {
        showMessage("Please login to scan attendance QR codes.", "error");
        logoutBtn.style.display = "none";
        stopScanner();
      }
    });

    // Logout button
    logoutBtn.addEventListener("click", () => {
      auth.signOut();
    });
  </script>
</body>

</html>
