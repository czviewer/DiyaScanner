<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OTP Login Test</title>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js" type="module"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js" type="module"></script>
  <style>
    body { font-family: Arial; padding: 30px; }
    input { padding: 10px; margin: 10px 0; width: 250px; }
    button { padding: 10px 20px; margin: 10px 0; }
    #recaptcha-container { margin-top: 15px; }
  </style>
</head>
<body>

<h2>OTP Login Test Page</h2>

<div>
  <label>Phone Number (+91 format)</label><br>
  <input id="phone-input" type="tel" placeholder="+919876543210" />
  <button id="send-otp-btn">Send OTP</button>
</div>

<div>
  <label>Enter OTP</label><br>
  <input id="otp-input" type="text" maxlength="6" placeholder="123456" />
  <button id="verify-otp-btn">Verify OTP</button>
</div>

<div id="recaptcha-container"></div>

<p id="result" style="color: green;"></p>
<p id="error" style="color: red;"></p>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
  import {
    getAuth,
    RecaptchaVerifier,
    signInWithPhoneNumber
  } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBU3K7gRzqiqQt3o9thoEpd06ReLGVmm_w",
    authDomain: "diya-hero.firebaseapp.com",
    databaseURL: "https://diya-hero-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "diya-hero",
    storageBucket: "diya-hero.firebasestorage.app",
    messagingSenderId: "455829653263",
    appId: "1:455829653263:web:5a31c65bdab2b9cee0607a",
    measurementId: "G-DZYHPLQD3F"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  let confirmationResult = null;

  const phoneInput = document.getElementById('phone-input');
  const otpInput = document.getElementById('otp-input');
  const sendOtpBtn = document.getElementById('send-otp-btn');
  const verifyOtpBtn = document.getElementById('verify-otp-btn');
  const resultText = document.getElementById('result');
  const errorText = document.getElementById('error');

  // Setup reCAPTCHA
  const recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
    'size': 'invisible',
    'callback': (response) => {
      console.log("reCAPTCHA resolved");
    },
    'expired-callback': () => {
      console.warn("reCAPTCHA expired");
    }
  });
  recaptchaVerifier.render().then((widgetId) => {
    window.recaptchaWidgetId = widgetId;
  });

  sendOtpBtn.addEventListener('click', async () => {
    resultText.textContent = '';
    errorText.textContent = '';

    const phoneNumber = phoneInput.value.trim();

    if (!phoneNumber.startsWith('+91')) {
      errorText.textContent = 'Please enter phone number with +91 format.';
      return;
    }

    try {
      confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, recaptchaVerifier);
      resultText.textContent = '✅ OTP sent successfully!';
      console.log('OTP sent to:', phoneNumber);
    } catch (error) {
      console.error('Error sending OTP:', error);
      errorText.textContent = '❌ OTP send failed: ' + error.message;
      grecaptcha.reset(window.recaptchaWidgetId); // important
    }
  });

  verifyOtpBtn.addEventListener('click', async () => {
    resultText.textContent = '';
    errorText.textContent = '';

    const otp = otpInput.value.trim();

    if (otp.length !== 6) {
      errorText.textContent = 'Enter 6 digit OTP.';
      return;
    }

    if (!confirmationResult) {
      errorText.textContent = 'No OTP session found. Send OTP first.';
      return;
    }

    try {
      const result = await confirmationResult.confirm(otp);
      const user = result.user;
      resultText.textContent = '✅ OTP verified successfully. UID: ' + user.uid;
      console.log('User signed in:', user);
    } catch (error) {
      console.error('OTP verification error:', error);
      errorText.textContent = '❌ OTP verification failed: ' + error.message;
    }
  });
</script>

<script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer></script>

</body>
</html>
